<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edutop Scholars - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary: #311b92; --primary-light: #4527a0; --secondary: #ff5722; --accent: #00bcd4; --light: #f5f5f7; --dark: #333; --success: #4caf50; --warning: #ff9800; --danger: #f44336; --gray: #777; --light-gray: #eee; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); color: var(--dark); min-height: 100vh; transition: background 0.3s, color 0.3s; }
        
        .header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 100; transition: background 0.3s; }
        .logo { display: flex; align-items: center; }
        .logo h1 { color: var(--primary); font-size: 28px; }
        .logo span { color: var(--secondary); }
        .user-info { display: flex; align-items: center; gap: 20px; }
        
        .mode-toggle { font-size: 20px; color: var(--gray); cursor: pointer; transition: color 0.3s; }
        .mode-toggle:hover { color: var(--primary); }

        .notification { position: relative; font-size: 20px; color: var(--gray); cursor: pointer; }
        .notification-count { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 12px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; display: none; }
        
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-name { font-weight: 600; }

        .dashboard-container { display: flex; min-height: calc(100vh - 80px); }
        .sidebar { width: 250px; background: white; padding: 25px 0; box-shadow: 3px 0 10px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; transition: background 0.3s; }
        .sidebar-section { margin-bottom: 30px; padding: 0 20px; }
        .sidebar-section h3 { color: var(--primary); margin-bottom: 15px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.3s; color: var(--dark); text-decoration: none; }
        .sidebar-item:hover { background: var(--light-gray); }
        .sidebar-item.active { background: var(--primary); color: white; }
        .sidebar-item i { width: 20px; text-align: center; }
        .subscription-status { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 15px; margin: 20px; border-radius: 10px; text-align: center; }
        .subscription-status h4 { margin-bottom: 5px; }
        .subscription-status p { font-size: 14px; opacity: 0.9; }

        .main-content { flex: 1; padding: 30px; }
        .welcome-section { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(49, 27, 146, 0.2); }
        .welcome-section h2 { font-size: 28px; margin-bottom: 10px; }
        .welcome-section p { opacity: 0.9; max-width: 600px; }
        
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 15px; transition: transform 0.3s, background 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }
        .stat-info h3 { font-size: 24px; margin-bottom: 5px; }
        .stat-info p { color: var(--gray); font-size: 14px; }

        .dashboard-actions { margin-bottom: 40px; }
        .dashboard-actions h2 { margin-bottom: 20px; color: var(--primary); font-size: 24px; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .action-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); transition: all 0.3s; cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .action-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
        .action-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; margin-bottom: 20px; }
        .action-card h3 { margin-bottom: 10px; color: var(--primary); }
        .action-card p { color: var(--gray); font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .action-btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: background 0.3s; width: 100%; max-width: 200px; }
        .action-btn:hover { background: var(--primary-light); }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; transition: background 0.3s; }
        .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); }
        .modal h2 { color: var(--primary); margin-bottom: 20px; text-align: center; }
        .subject-selection { margin-bottom: 30px; }
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .subject-card { background: var(--light); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .subject-card.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .subject-card:hover:not(.selected) { border-color: var(--primary); }
        .subject-icon { font-size: 30px; margin-bottom: 10px; color: var(--primary); }
        .subject-card.selected .subject-icon { color: white; }
        .selected-subjects { background: #f0f7ff; padding: 20px; border-radius: 10px; margin-top: 30px; }
        .selected-subjects h4 { margin-bottom: 15px; color: var(--primary); }
        .selected-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .selected-tag { background: var(--primary); color: white; padding: 8px 15px; border-radius: 50px; display: flex; align-items: center; gap: 8px; }
        .remove-subject { background: none; border: none; color: white; cursor: pointer; font-size: 14px; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .modal-btn { padding: 12px 30px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .modal-btn.primary { background: var(--primary); color: white; }
        .modal-btn.secondary { background: var(--light-gray); color: var(--dark); }
        
        .recent-activity { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); transition: background 0.3s; }
        .recent-activity h2 { color: var(--primary); margin-bottom: 20px; font-size: 24px; }
        .activity-list { display: flex; flex-direction: column; gap: 15px; }
        .activity-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 10px; background: var(--light); }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .activity-info h4 { margin-bottom: 5px; }
        .activity-info p { color: var(--gray); font-size: 14px; }
        .footer { background: white; padding: 20px; text-align: center; color: var(--gray); font-size: 14px; margin-top: 40px; border-top: 1px solid var(--light-gray); transition: background 0.3s; }

        /* DARK MODE STYLES */
        body.dark-mode { background: linear-gradient(135deg, #121212 0%, #1f1f1f 100%); color: #e0e0e0; }
        body.dark-mode .header { background: #1e1e1e; box-shadow: 0 3px 10px rgba(0,0,0,0.5); }
        body.dark-mode .sidebar { background: #1e1e1e; box-shadow: 3px 0 10px rgba(0,0,0,0.2); }
        body.dark-mode .sidebar-item { color: #e0e0e0; }
        body.dark-mode .sidebar-item:hover { background: #333; }
        body.dark-mode .stat-card { background: #1e1e1e; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        body.dark-mode .stat-info h3 { color: #fff; }
        body.dark-mode .action-card { background: #1e1e1e; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        body.dark-mode .action-card h3 { color: #9fa8da; }
        body.dark-mode .recent-activity { background: #1e1e1e; }
        body.dark-mode .activity-item { background: #2d2d2d; }
        body.dark-mode .activity-info h4 { color: #fff; }
        body.dark-mode .footer { background: #1e1e1e; border-top: 1px solid #333; }
        body.dark-mode .modal { background: #1e1e1e; color: #fff; }
        body.dark-mode .subject-card { background: #2d2d2d; }
        body.dark-mode .subject-card:hover:not(.selected) { border-color: #9fa8da; }
        body.dark-mode .selected-subjects { background: #2d2d2d; }
        body.dark-mode .modal-btn.secondary { background: #333; color: #fff; }

        @media (max-width: 992px) { .dashboard-container { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; padding: 15px; } .sidebar-section { margin-bottom: 15px; } .action-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); } }
        @media (max-width: 768px) { .header { padding: 15px; flex-direction: column; gap: 15px; } .stats-cards { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } .action-grid { grid-template-columns: 1fr; } .subject-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <h1>Edutop<span>Scholars</span></h1>
        </div>
        <div class="user-info">
            <div class="mode-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </div>
            <div class="notification">
                <i class="fas fa-bell"></i>
                <div class="notification-count" id="notification-badge"></div>
            </div>
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar-display">...</div>
                <div>
                    <div class="user-name" id="user-name-display">Loading...</div>
                    <div style="font-size: 12px; color: var(--gray);" id="user-plan-display">Checking...</div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-section">
                <h3>Navigation</h3>
                <a href="#" class="sidebar-item active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="resources.html" class="sidebar-item">
                    <i class="fas fa-book-open"></i>
                    <span>Study Materials</span>
                </a>
                <a href="history.html" class="sidebar-item">
                    <i class="fas fa-history"></i>
                    <span>Exam History</span>
                </a>
                <a href="analytics.html" class="sidebar-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Performance Analytics</span>
                </a>
                <a href="study-groups.html" class="sidebar-item">
                    <i class="fas fa-users"></i>
                    <span>Study Groups</span>
                </a>
            </div>

            <div class="sidebar-section">
                <h3>Account</h3>
                <a href="profile.html" class="sidebar-item">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </a>
                <a href="subscription.html" class="sidebar-item">
                    <i class="fas fa-credit-card"></i>
                    <span>Subscription</span>
                </a>
                <a href="settings.html" class="sidebar-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#" class="sidebar-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>

            <div class="subscription-status">
                <h4 id="sidebar-plan-name">Loading...</h4>
                <p>Status: Active</p>
                <p style="margin-top: 10px; font-size: 12px;">Next billing: 30 Nov 2026</p>
            </div>
        </nav>

        <main class="main-content">
            <section class="welcome-section">
                <h2 id="welcome-msg">Welcome!</h2>
                <p id="welcome-subtext">Fetching your profile data...</p>
            </section>

            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-score">--%</h3>
                        <p>Overall Score</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success);">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-exams">0</h3>
                        <p>Exams Taken</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--accent);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-hours">0h</h3>
                        <p>Study Hours</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning);">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-ranking">--</h3>
                        <p>National Ranking</p>
                    </div>
                </div>
            </div>

            <section class="dashboard-actions">
                <h2>Quick Actions</h2>
                <div class="action-grid">
                    <div class="action-card" id="subject-selection-btn">
                        <div class="action-icon" style="background: linear-gradient(135deg, #311b92 0%, #4527a0 100%);">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3>Select Subjects</h3>
                        <p>Choose your 4 JAMB subjects for personalized practice and exams</p>
                        <button class="action-btn">Select Subjects</button>
                    </div>

                    <div class="action-card" onclick="window.location.href='exam.html'">
                        <div class="action-icon" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <h3>Attempt Exam Alone</h3>
                        <p>Take a timed practice exam with questions from your selected subjects</p>
                        <button class="action-btn">Start Exam</button>
                    </div>

                    <div class="action-card" onclick="window.location.href='multiplayer.html'">
                        <div class="action-icon" style="background: linear-gradient(135deg, #2196f3 0%, #0d47a1 100%);">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Attempt with Friends</h3>
                        <p>Invite friends for a collaborative exam session and compare scores</p>
                        <button class="action-btn">Invite Friends</button>
                    </div>

                    <div class="action-card" onclick="window.location.href='resources.html'">
                        <div class="action-icon" style="background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3>Study Resources</h3>
                        <p>Access textbooks, past questions, and study materials for all subjects</p>
                        <button class="action-btn">Browse Resources</button>
                    </div>

                    <div class="action-card" onclick="window.location.href='forum.html'">
                        <div class="action-icon" style="background: linear-gradient(135deg, #ff9800 0%, #ef6c00 100%);">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <h3>Ask a Question</h3>
                        <p>Get help from tutors and other students in our academic community</p>
                        <button class="action-btn">Ask Now</button>
                    </div>

                    <div class="action-card" onclick="window.location.href='hire.html'">
                        <div class="action-icon" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h3>Hire Private Tutor</h3>
                        <p>Connect with certified tutors for one-on-one personalized lessons</p>
                        <button class="action-btn">Find Tutor</button>
                    </div>
                </div>
            </section>

            <section class="recent-activity">
                <h2>Recent Activity</h2>
                <div class="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon" style="background: var(--primary);">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-info">
                            <h4>Login Successful</h4>
                            <p>You accessed your dashboard</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <footer class="footer">
        <p>Edutop Scholars &copy; 2026. All rights reserved. | Over 2000+ questions per subject</p>
    </footer>

    <div class="modal-overlay" id="subjectModal">
        <div class="modal">
            <button class="modal-close" id="closeModal">&times;</button>
            <h2>Select Your 4 JAMB Subjects</h2>
            <p style="text-align: center; margin-bottom: 20px; color: var(--gray);">You can select up to 4 subjects. Your selection will determine your practice materials and exam questions.</p>
            
            <div class="subject-selection">
                <div class="subject-grid">
                    <div class="subject-card" data-subject="Mathematics"><div class="subject-icon"><i class="fas fa-square-root-alt"></i></div><h4>Mathematics</h4></div>
                    <div class="subject-card" data-subject="Physics"><div class="subject-icon"><i class="fas fa-atom"></i></div><h4>Physics</h4></div>
                    <div class="subject-card" data-subject="Chemistry"><div class="subject-icon"><i class="fas fa-flask"></i></div><h4>Chemistry</h4></div>
                    <div class="subject-card" data-subject="Biology"><div class="subject-icon"><i class="fas fa-dna"></i></div><h4>Biology</h4></div>
                    <div class="subject-card" data-subject="English"><div class="subject-icon"><i class="fas fa-language"></i></div><h4>English</h4></div>
                    <div class="subject-card" data-subject="Literature"><div class="subject-icon"><i class="fas fa-book-reader"></i></div><h4>Literature</h4></div>
                    <div class="subject-card" data-subject="Government"><div class="subject-icon"><i class="fas fa-landmark"></i></div><h4>Government</h4></div>
                    <div class="subject-card" data-subject="Economics"><div class="subject-icon"><i class="fas fa-chart-line"></i></div><h4>Economics</h4></div>
                    <div class="subject-card" data-subject="Geography"><div class="subject-icon"><i class="fas fa-globe-africa"></i></div><h4>Geography</h4></div>
                    <div class="subject-card" data-subject="Commerce"><div class="subject-icon"><i class="fas fa-shopping-cart"></i></div><h4>Commerce</h4></div>
                    <div class="subject-card" data-subject="Accounting"><div class="subject-icon"><i class="fas fa-calculator"></i></div><h4>Accounting</h4></div>
                    <div class="subject-card" data-subject="CRS"><div class="subject-icon"><i class="fas fa-church"></i></div><h4>CRS</h4></div>
                    <div class="subject-card" data-subject="History"><div class="subject-icon"><i class="fas fa-hourglass-half"></i></div><h4>History</h4></div>
                    <div class="subject-card" data-subject="Agric Sci"><div class="subject-icon"><i class="fas fa-seedling"></i></div><h4>Agric Sci</h4></div>
                    <div class="subject-card" data-subject="Civic Edu"><div class="subject-icon"><i class="fas fa-balance-scale"></i></div><h4>Civic Edu</h4></div>
                    <div class="subject-card" data-subject="IRS"><div class="subject-icon"><i class="fas fa-mosque"></i></div><h4>IRS</h4></div>
                    <div class="subject-card" data-subject="French"><div class="subject-icon"><i class="fas fa-comments"></i></div><h4>French</h4></div>
                    <div class="subject-card" data-subject="Data Proc"><div class="subject-icon"><i class="fas fa-database"></i></div><h4>Data Proc</h4></div>
                </div>
                
                <div class="selected-subjects">
                    <h4>Selected Subjects (4 maximum)</h4>
                    <div class="selected-list" id="selectedList"></div>
                    <p id="selectionCount" style="margin-top: 15px; color: var(--gray); font-size: 14px;">0 subjects selected</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelSelection">Cancel</button>
                <button class="modal-btn primary" id="saveSubjects">Save Selection</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCictHNxtslYs9VR0hoicxlwPn_QghkgIA",
            authDomain: "edutop-7ff51.firebaseapp.com",
            projectId: "edutop-7ff51",
            storageBucket: "edutop-7ff51.firebasestorage.app",
            messagingSenderId: "79307850494",
            appId: "1:79307850494:web:b51ce51204140ec5429baf",
            measurementId: "G-GGGH590BYS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUserUid = null;
        let selectedSubjects = [];

        // THEME TOGGLER LOGIC
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const icon = themeToggle.querySelector('i');

        // Check local storage for preference
        if(localStorage.getItem('theme') === 'dark') {
            body.classList.add('dark-mode');
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            if(body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                localStorage.setItem('theme', 'light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });

        // 1. AUTH & REAL-TIME DATA LISTENER
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUid = user.uid;
                
                const userRef = doc(db, "users", currentUserUid);
                
                onSnapshot(userRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        updateUI(data);
                    } else {
                        // Create profile with default STATS if missing
                        const defaultData = {
                            fullName: user.displayName || "New Scholar",
                            email: user.email,
                            subscriptionPlan: "Free",
                            selectedSubjects: [],
                            // Default Stats Initialization
                            stats: {
                                overallScore: 0,
                                examsTaken: 0,
                                studyHours: 0,
                                ranking: "--"
                            },
                            // Default Notifications
                            notifications: [],
                            createdAt: new Date().toISOString()
                        };
                        
                        try {
                            await setDoc(userRef, defaultData);
                        } catch (e) {
                            console.error("Error creating profile:", e);
                        }
                    }
                }, (error) => {
                    console.error("Listener error:", error);
                });

            } else {
                window.location.href = "index.html";
            }
        });

        // 2. UPDATE UI FUNCTION
        function updateUI(userData) {
            // --- BASIC INFO ---
            const fullName = userData.fullName || "Scholar";
            document.getElementById('user-name-display').innerText = fullName;
            document.getElementById('welcome-msg').innerText = `Welcome back, ${fullName.split(' ')[0]}!`;
            
            const initials = fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-avatar-display').innerText = initials;

            const plan = (userData.subscriptionPlan || "Free").toUpperCase();
            document.getElementById('user-plan-display').innerText = `${plan} Plan`;
            document.getElementById('sidebar-plan-name').innerText = `${plan} Plan`;

            // --- REAL-TIME STATS ---
            // We use '|| 0' so it defaults to 0 if the field doesn't exist yet
            const stats = userData.stats || {};
            
            document.getElementById('stat-score').innerText = (stats.overallScore || 0) + '%';
            document.getElementById('stat-exams').innerText = stats.examsTaken || 0;
            document.getElementById('stat-hours').innerText = (stats.studyHours || 0) + 'h';
            document.getElementById('stat-ranking').innerText = stats.ranking || '--';

            // --- REAL-TIME NOTIFICATIONS ---
            const notifications = userData.notifications || [];
            // Logic: Count how many are unread (assuming you might add 'read: true' later)
            // For now, just counting the array length
            const notifCount = notifications.length;
            
            const badge = document.getElementById('notification-badge');
            if(notifCount > 0) {
                badge.style.display = 'flex';
                badge.innerText = notifCount > 9 ? '9+' : notifCount;
            } else {
                badge.style.display = 'none';
            }

            // --- SUBJECTS ---
            selectedSubjects = userData.selectedSubjects || [];
            const welcomeSubtext = document.getElementById('welcome-subtext');
            const subjectBtn = document.querySelector('#subject-selection-btn .action-btn');

            if (selectedSubjects.length > 0) {
                welcomeSubtext.innerHTML = `You are practicing: <strong>${selectedSubjects.join(', ')}</strong>`;
                subjectBtn.textContent = 'Change Subjects';
            } else {
                welcomeSubtext.innerText = "You haven't selected your subjects yet. Please select them to get personalized recommendations.";
                subjectBtn.textContent = 'Select Subjects';
            }
            
            if(document.getElementById('subjectModal').style.display === 'flex'){
                renderSubjectSelection();
            }
        }

        // 3. MODAL LOGIC
        const subjectModal = document.getElementById('subjectModal');
        const subjectSelectionBtn = document.getElementById('subject-selection-btn');
        const closeModal = document.getElementById('closeModal');
        const cancelSelection = document.getElementById('cancelSelection');
        const subjectCards = document.querySelectorAll('.subject-card');
        const selectedList = document.getElementById('selectedList');
        const selectionCount = document.getElementById('selectionCount');
        const saveSubjectsBtn = document.getElementById('saveSubjects');

        subjectSelectionBtn.addEventListener('click', () => { 
            subjectModal.style.display = 'flex'; 
            renderSubjectSelection(); 
        });
        const hideModal = () => { subjectModal.style.display = 'none'; };
        closeModal.addEventListener('click', hideModal);
        cancelSelection.addEventListener('click', hideModal);
        subjectModal.addEventListener('click', (e) => { if (e.target === subjectModal) hideModal(); });

        subjectCards.forEach(card => {
            card.addEventListener('click', function() {
                const subject = this.getAttribute('data-subject');
                const index = selectedSubjects.indexOf(subject);
                
                if (index === -1) {
                    if (selectedSubjects.length < 4) selectedSubjects.push(subject);
                    else alert('Maximum 4 subjects allowed.');
                } else {
                    selectedSubjects.splice(index, 1);
                }
                renderSubjectSelection();
            });
        });

        function renderSubjectSelection() {
            document.querySelectorAll('.subject-card').forEach(c => c.classList.remove('selected'));
            selectedSubjects.forEach(sub => {
                const card = document.querySelector(`.subject-card[data-subject="${sub}"]`);
                if(card) card.classList.add('selected');
            });

            selectedList.innerHTML = '';
            selectedSubjects.forEach(subject => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `${subject}`;
                selectedList.appendChild(tag);
            });

            selectionCount.textContent = `${selectedSubjects.length} subjects selected`;
            
            if (selectedSubjects.length === 4) {
                saveSubjectsBtn.disabled = false;
                saveSubjectsBtn.style.opacity = '1';
                selectionCount.style.color = 'var(--success)';
            } else {
                saveSubjectsBtn.disabled = true;
                saveSubjectsBtn.style.opacity = '0.6';
                selectionCount.style.color = 'var(--gray)';
            }
        }

        // 4. SAVE TO FIREBASE
        saveSubjectsBtn.addEventListener('click', async () => {
            if (!currentUserUid) return;
            const originalText = saveSubjectsBtn.innerText;
            saveSubjectsBtn.innerText = "Saving...";
            
            try {
                const userRef = doc(db, "users", currentUserUid);
                await setDoc(userRef, { 
                    selectedSubjects: selectedSubjects,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                alert("Subjects saved!");
                hideModal();
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to save: " + error.message);
            } finally {
                saveSubjectsBtn.innerText = originalText;
            }
        });

        // 5. LOGOUT
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = "index.html";
        });

    </script>
</body>
</html>

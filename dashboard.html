<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAMB CBT Master - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS REMAINS EXACTLY THE SAME AS YOUR TEMPLATE */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary: #311b92; --primary-light: #4527a0; --secondary: #ff5722; --accent: #00bcd4; --light: #f5f5f7; --dark: #333; --success: #4caf50; --warning: #ff9800; --danger: #f44336; --gray: #777; --light-gray: #eee; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); color: var(--dark); min-height: 100vh; display: none; /* Hidden until auth check passes */ }
        
        /* Header */
        .header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; }
        .logo h1 { color: var(--primary); font-size: 28px; }
        .logo span { color: var(--secondary); }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .notification { position: relative; font-size: 20px; color: var(--gray); cursor: pointer; }
        .notification-count { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 12px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; text-transform: uppercase; }
        .user-name { font-weight: 600; }

        /* Dashboard Layout */
        .dashboard-container { display: flex; min-height: calc(100vh - 80px); }
        .sidebar { width: 250px; background: white; padding: 25px 0; box-shadow: 3px 0 10px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; }
        .sidebar-section { margin-bottom: 30px; padding: 0 20px; }
        .sidebar-section h3 { color: var(--primary); margin-bottom: 15px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.3s; color: var(--dark); text-decoration: none; }
        .sidebar-item:hover { background: var(--light-gray); }
        .sidebar-item.active { background: var(--primary); color: white; }
        .sidebar-item i { width: 20px; text-align: center; }
        .subscription-status { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 15px; margin: 20px; border-radius: 10px; text-align: center; }
        .subscription-status h4 { margin-bottom: 5px; text-transform: capitalize; }
        .subscription-status p { font-size: 14px; opacity: 0.9; }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; }
        .welcome-section { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(49, 27, 146, 0.2); }
        .welcome-section h2 { font-size: 28px; margin-bottom: 10px; }
        .welcome-section p { opacity: 0.9; max-width: 600px; }
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 15px; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }
        .stat-info h3 { font-size: 24px; margin-bottom: 5px; }
        .stat-info p { color: var(--gray); font-size: 14px; }

        /* Dashboard Actions */
        .dashboard-actions { margin-bottom: 40px; }
        .dashboard-actions h2 { margin-bottom: 20px; color: var(--primary); font-size: 24px; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .action-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); transition: all 0.3s; cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .action-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
        .action-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; margin-bottom: 20px; }
        .action-card h3 { margin-bottom: 10px; color: var(--primary); }
        .action-card p { color: var(--gray); font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .action-btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: background 0.3s; width: 100%; max-width: 200px; }
        .action-btn:hover { background: var(--primary-light); }

        /* Subject Selection Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; }
        .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); }
        .modal h2 { color: var(--primary); margin-bottom: 20px; text-align: center; }
        .subject-selection { margin-bottom: 30px; }
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .subject-card { background: var(--light); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .subject-card.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .subject-card:hover:not(.selected) { border-color: var(--primary); }
        .subject-icon { font-size: 30px; margin-bottom: 10px; color: var(--primary); }
        .subject-card.selected .subject-icon { color: white; }
        .selected-subjects { background: #f0f7ff; padding: 20px; border-radius: 10px; margin-top: 30px; }
        .selected-subjects h4 { margin-bottom: 15px; color: var(--primary); }
        .selected-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .selected-tag { background: var(--primary); color: white; padding: 8px 15px; border-radius: 50px; display: flex; align-items: center; gap: 8px; }
        .remove-subject { background: none; border: none; color: white; cursor: pointer; font-size: 14px; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .modal-btn { padding: 12px 30px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .modal-btn.primary { background: var(--primary); color: white; }
        .modal-btn.secondary { background: var(--light-gray); color: var(--dark); }
        .recent-activity { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); }
        .recent-activity h2 { color: var(--primary); margin-bottom: 20px; font-size: 24px; }
        .activity-list { display: flex; flex-direction: column; gap: 15px; }
        .activity-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 10px; background: var(--light); }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .activity-info h4 { margin-bottom: 5px; }
        .activity-info p { color: var(--gray); font-size: 14px; }
        .footer { background: white; padding: 20px; text-align: center; color: var(--gray); font-size: 14px; margin-top: 40px; border-top: 1px solid var(--light-gray); }
        @media (max-width: 992px) { .dashboard-container { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; padding: 15px; } .sidebar-section { margin-bottom: 15px; } .action-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); } }
        @media (max-width: 768px) { .header { padding: 15px; flex-direction: column; gap: 15px; } .stats-cards { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } .action-grid { grid-template-columns: 1fr; } .subject-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <h1>JAMB<span>Master</span></h1>
        </div>
        <div class="user-info">
            <div class="notification">
                <i class="fas fa-bell"></i>
                <div class="notification-count">3</div>
            </div>
            <div class="user-profile">
                <div class="user-avatar" id="header-avatar">--</div>
                <div>
                    <div class="user-name" id="header-name">Loading...</div>
                    <div style="font-size: 12px; color: var(--gray);" id="header-plan">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-section">
                <h3>Navigation</h3>
                <a href="#" class="sidebar-item active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="sidebar-item">
                    <i class="fas fa-book-open"></i>
                    <span>Study Materials</span>
                </a>
                <a href="#" class="sidebar-item">
                    <i class="fas fa-history"></i>
                    <span>Exam History</span>
                </a>
            </div>

            <div class="sidebar-section">
                <h3>Account</h3>
                <a href="#" class="sidebar-item">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </a>
                <a href="#" class="sidebar-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>

            <div class="subscription-status">
                <h4 id="sidebar-plan">Loading Plan...</h4>
                <p id="expiry-date">Calculated based on signup</p>
                <p style="margin-top: 10px; font-size: 12px;">Active Status</p>
            </div>
        </nav>

        <main class="main-content">
            <section class="welcome-section">
                <h2 id="welcome-msg">Welcome back!</h2>
                <p id="welcome-text">Loading your personalized progress...</p>
            </section>

            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>0%</h3>
                        <p>Overall Score</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success);">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <h3>0</h3>
                        <p>Exams Taken</p>
                    </div>
                </div>
                </div>

            <section class="dashboard-actions">
                <h2>Quick Actions</h2>
                <div class="action-grid">
                    <div class="action-card" id="subject-selection-btn">
                        <div class="action-icon" style="background: linear-gradient(135deg, #311b92 0%, #4527a0 100%);">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3>Select Subjects</h3>
                        <p>Choose your 4 JAMB subjects for personalized practice and exams</p>
                        <button class="action-btn" id="subject-btn-text">Select Subjects</button>
                    </div>

                    <div class="action-card">
                        <div class="action-icon" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <h3>Attempt Exam Alone</h3>
                        <p>Take a timed practice exam with questions from your selected subjects</p>
                        <button class="action-btn">Start Exam</button>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-icon" style="background: linear-gradient(135deg, #2196f3 0%, #0d47a1 100%);">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Attempt with Friends</h3>
                        <p>Invite friends for a collaborative exam session and compare scores</p>
                        <button class="action-btn">Invite Friends</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="subjectModal">
        <div class="modal">
            <button class="modal-close" id="closeModal">&times;</button>
            <h2>Select Your 4 JAMB Subjects</h2>
            <p style="text-align: center; margin-bottom: 20px; color: var(--gray);">You can select up to 4 subjects.</p>
            
            <div class="subject-selection">
                <div class="subject-grid">
                    <div class="subject-card" data-subject="Mathematics"><div class="subject-icon"><i class="fas fa-square-root-alt"></i></div><h4>Mathematics</h4></div>
                    <div class="subject-card" data-subject="Physics"><div class="subject-icon"><i class="fas fa-atom"></i></div><h4>Physics</h4></div>
                    <div class="subject-card" data-subject="Chemistry"><div class="subject-icon"><i class="fas fa-flask"></i></div><h4>Chemistry</h4></div>
                    <div class="subject-card" data-subject="Biology"><div class="subject-icon"><i class="fas fa-dna"></i></div><h4>Biology</h4></div>
                    <div class="subject-card" data-subject="English"><div class="subject-icon"><i class="fas fa-language"></i></div><h4>English</h4></div>
                    <div class="subject-card" data-subject="Literature"><div class="subject-icon"><i class="fas fa-book-reader"></i></div><h4>Literature</h4></div>
                    <div class="subject-card" data-subject="Government"><div class="subject-icon"><i class="fas fa-landmark"></i></div><h4>Government</h4></div>
                    <div class="subject-card" data-subject="Economics"><div class="subject-icon"><i class="fas fa-chart-line"></i></div><h4>Economics</h4></div>
                </div>
                
                <div class="selected-subjects">
                    <h4>Selected Subjects</h4>
                    <div class="selected-list" id="selectedList"></div>
                    <p id="selectionCount" style="margin-top: 15px; color: var(--gray); font-size: 14px;">0 subjects selected</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelSelection">Cancel</button>
                <button class="modal-btn primary" id="saveSubjects" disabled style="opacity: 0.6;">Save Selection</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Your Firebase Configuration (Same as Login Page)
        const firebaseConfig = {
            apiKey: "AIzaSyCictHNxtslYs9VR0hoicxlwPn_QghkgIA",
            authDomain: "edutop-7ff51.firebaseapp.com",
            projectId: "edutop-7ff51",
            storageBucket: "edutop-7ff51.firebasestorage.app",
            messagingSenderId: "79307850494",
            appId: "1:79307850494:web:b51ce51204140ec5429baf",
            measurementId: "G-GGGH590BYS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let selectedSubjects = [];

        // 1. Check Authentication & Load Data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // User is signed in, verify Firestore data
                try {
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        updateDashboardUI(userData);
                        document.body.style.display = 'block'; // Show dashboard
                        
                        // Load saved subjects if they exist
                        if (userData.selectedSubjects) {
                            selectedSubjects = userData.selectedSubjects;
                            updateWelcomeWithSubjects(selectedSubjects);
                        }
                    } else {
                        console.log("No such document!");
                        // Fallback if google login didn't create doc yet
                        document.getElementById('header-name').innerText = user.displayName;
                        document.body.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                }
            } else {
                // User is signed out, redirect to login
                window.location.href = "index.html"; // ASSUMING LOGIN IS index.html
            }
        });

        // 2. UI Update Functions
        function updateDashboardUI(data) {
            // Header
            document.getElementById('header-name').innerText = data.fullName;
            document.getElementById('header-plan').innerText = (data.subscriptionPlan || "Basic") + " Plan";
            
            // Initials
            const names = data.fullName.split(' ');
            const initials = names.length > 1 ? names[0][0] + names[1][0] : names[0][0] + names[0][1];
            document.getElementById('header-avatar').innerText = initials.toUpperCase();
            
            // Sidebar
            document.getElementById('sidebar-plan').innerText = (data.subscriptionPlan || "Basic").toUpperCase();
            document.getElementById('welcome-msg').innerText = `Welcome back, ${names[0]}!`;
            
            // Calculate pseudo-expiry date (30 days from created)
            const created = new Date(data.createdAt);
            const expiry = new Date(created.setDate(created.getDate() + 30));
            document.getElementById('expiry-date').innerText = `Expires: ${expiry.toLocaleDateString()}`;
        }

        function updateWelcomeWithSubjects(subjects) {
            const welcomeText = document.getElementById('welcome-text');
            const btnText = document.getElementById('subject-btn-text');
            
            if (subjects && subjects.length > 0) {
                welcomeText.innerHTML = `You are practicing: <strong>${subjects.join(', ')}</strong>. Keep pushing!`;
                btnText.innerText = "Change Subjects";
            } else {
                welcomeText.innerText = "Please select your 4 JAMB subjects to start practicing.";
                btnText.innerText = "Select Subjects";
            }
        }

        // 3. Logout Logic
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                alert('Logged out successfully');
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Logout Error", error);
            });
        });

        // 4. Modal & Selection Logic
        const subjectModal = document.getElementById('subjectModal');
        const subjectSelectionBtn = document.getElementById('subject-selection-btn');
        const closeModal = document.getElementById('closeModal');
        const cancelSelection = document.getElementById('cancelSelection');
        const saveSubjectsBtn = document.getElementById('saveSubjects');
        const selectedList = document.getElementById('selectedList');
        const selectionCount = document.getElementById('selectionCount');
        const subjectCards = document.querySelectorAll('.subject-card');

        // Open Modal
        subjectSelectionBtn.addEventListener('click', () => {
            subjectModal.style.display = 'flex';
            // Sync UI with current array
            renderSelectionUI();
        });

        // Close Modals
        const closeFunc = () => { subjectModal.style.display = 'none'; };
        closeModal.addEventListener('click', closeFunc);
        cancelSelection.addEventListener('click', closeFunc);

        // Subject Card Click
        subjectCards.forEach(card => {
            card.addEventListener('click', function() {
                const subject = this.getAttribute('data-subject');
                const index = selectedSubjects.indexOf(subject);

                if (index === -1) {
                    // Add
                    if (selectedSubjects.length < 4) {
                        selectedSubjects.push(subject);
                    } else {
                        alert("Maximum 4 subjects allowed.");
                    }
                } else {
                    // Remove
                    selectedSubjects.splice(index, 1);
                }
                renderSelectionUI();
            });
        });

        // Render the visual state of the modal based on selectedSubjects array
        function renderSelectionUI() {
            selectedList.innerHTML = '';
            
            // 1. Highlight Cards
            document.querySelectorAll('.subject-card').forEach(card => {
                const sub = card.getAttribute('data-subject');
                if (selectedSubjects.includes(sub)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // 2. Render Tags
            selectedSubjects.forEach(subject => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `${subject} <button class="remove-subject" data-s="${subject}"><i class="fas fa-times"></i></button>`;
                selectedList.appendChild(tag);
            });

            // 3. Update Count & Button State
            selectionCount.innerText = `${selectedSubjects.length} subjects selected`;
            
            if (selectedSubjects.length === 4) {
                saveSubjectsBtn.disabled = false;
                saveSubjectsBtn.style.opacity = '1';
                selectionCount.style.color = 'var(--success)';
            } else {
                saveSubjectsBtn.disabled = true;
                saveSubjectsBtn.style.opacity = '0.6';
                selectionCount.style.color = 'var(--gray)';
            }

            // 4. Bind Remove Buttons
            document.querySelectorAll('.remove-subject').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const s = e.currentTarget.getAttribute('data-s');
                    const idx = selectedSubjects.indexOf(s);
                    if(idx > -1) selectedSubjects.splice(idx, 1);
                    renderSelectionUI();
                });
            });
        }

        // Save to Firebase
        saveSubjectsBtn.addEventListener('click', async () => {
            if(!currentUser) return;
            
            saveSubjectsBtn.innerText = "Saving...";
            
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    selectedSubjects: selectedSubjects
                });
                
                alert("Subjects saved successfully!");
                updateWelcomeWithSubjects(selectedSubjects);
                closeFunc();
            } catch (e) {
                console.error("Error saving subjects: ", e);
                alert("Failed to save subjects.");
            } finally {
                saveSubjectsBtn.innerText = "Save Selection";
            }
        });

    </script>
</body>
</html>

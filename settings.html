<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Edutop Scholars</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #311b92;
            --primary-light: #4527a0;
            --secondary: #ff5722;
            --accent: #00bcd4;
            --light: #f5f5f7;
            --dark: #333;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --gray: #777;
            --light-gray: #eee;
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-text: #ffffff;
        }
        
        body {
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        
        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        body.dark-mode .header {
            background: var(--dark-card);
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo h1 {
            color: var(--primary);
            font-size: 28px;
        }
        
        .logo span {
            color: var(--secondary);
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        body.dark-mode .nav-link {
            color: var(--dark-text);
        }
        
        .nav-link:hover {
            background: rgba(49, 27, 146, 0.1);
        }
        
        .nav-link.active {
            background: var(--primary);
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .page-header {
            margin-bottom: 40px;
        }
        
        .page-header h1 {
            color: var(--primary);
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        body.dark-mode .page-header h1 {
            color: #bb86fc;
        }
        
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        body.dark-mode .settings-section {
            background: var(--dark-card);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        body.dark-mode .section-header {
            border-color: #333;
        }
        
        .section-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 22px;
        }
        
        body.dark-mode .section-title {
            color: #bb86fc;
        }
        
        .settings-grid {
            display: grid;
            gap: 20px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--light);
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        body.dark-mode .setting-item {
            background: #2d2d2d;
        }
        
        .setting-item:hover {
            background: rgba(49, 27, 146, 0.1);
        }
        
        .setting-info {
            flex: 1;
        }
        
        .setting-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        body.dark-mode .setting-title {
            color: #bb86fc;
        }
        
        .setting-description {
            font-size: 14px;
            color: var(--gray);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        .btn {
            padding: 10px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        body.dark-mode .form-group label {
            color: #bb86fc;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        body.dark-mode .form-control {
            background: var(--dark-card);
            border-color: #333;
            color: var(--dark-text);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .code-inputs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .code-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            background: white;
        }
        
        body.dark-mode .code-input {
            background: var(--dark-card);
            border-color: #333;
            color: var(--dark-text);
        }
        
        .code-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            position: relative;
        }
        
        body.dark-mode .modal {
            background: var(--dark-card);
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-title {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }
        
        body.dark-mode .modal-title {
            color: #bb86fc;
        }
        
        .modal-message {
            text-align: center;
            margin-bottom: 30px;
            color: var(--gray);
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.danger {
            background: var(--danger);
            color: white;
        }
        
        .modal-btn.secondary {
            background: var(--light-gray);
            color: var(--dark);
        }
        
        body.dark-mode .modal-btn.secondary {
            background: #333;
            color: var(--dark-text);
        }
        
        .notification-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .notification-box.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification-box.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .code-inputs {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <h1>Edutop<span>Scholars</span></h1>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
            <a href="resources.html" class="nav-link"><i class="fas fa-book-open"></i> Study Materials</a>
            <a href="profile.html" class="nav-link"><i class="fas fa-user-circle"></i> Profile</a>
            <a href="settings.html" class="nav-link active"><i class="fas fa-cog"></i> Settings</a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-cog"></i> Settings</h1>
            <p style="color: var(--gray);">Manage your account preferences and security settings</p>
        </div>
        
        <!-- Theme Settings -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-palette"></i>
                </div>
                <h2 class="section-title">Appearance</h2>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Dark Mode</div>
                        <div class="setting-description">Switch between light and dark theme</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Font Size</div>
                        <div class="setting-description">Adjust text size for better readability</div>
                    </div>
                    <select id="fontSizeSelect" style="padding: 8px 15px; border-radius: 8px; border: 2px solid var(--light-gray);">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Account Security -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="section-title">Account Security</h2>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Change Password</div>
                        <div class="setting-description">Update your account password</div>
                    </div>
                    <button class="btn btn-primary" onclick="openPasswordModal()">Change</button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Two-Factor Authentication</div>
                        <div class="setting-description">Add an extra layer of security</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="twoFactorToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Login Activity</div>
                        <div class="setting-description">View recent login sessions</div>
                    </div>
                    <button class="btn btn-primary" onclick="viewLoginActivity()">View</button>
                </div>
            </div>
        </div>
        
        <!-- Notifications -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <h2 class="section-title">Notifications</h2>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Email Notifications</div>
                        <div class="setting-description">Receive updates via email</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="emailNotifications" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Exam Reminders</div>
                        <div class="setting-description">Get reminders for scheduled exams</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="examReminders" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Study Goals</div>
                        <div class="setting-description">Notifications for study goals</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="studyGoals" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Privacy -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <h2 class="section-title">Privacy</h2>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Profile Visibility</div>
                        <div class="setting-description">Control who can see your profile</div>
                    </div>
                    <select id="profileVisibility" style="padding: 8px 15px; border-radius: 8px; border: 2px solid var(--light-gray);">
                        <option value="public">Public</option>
                        <option value="friends">Friends Only</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Data Sharing</div>
                        <div class="setting-description">Allow anonymous data for research</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dataSharing">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Account Management -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <h2 class="section-title">Account Management</h2>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Export Data</div>
                        <div class="setting-description">Download all your data</div>
                    </div>
                    <button class="btn btn-primary" onclick="exportData()">Export</button>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Delete Account</div>
                        <div class="setting-description">Permanently delete your account</div>
                    </div>
                    <button class="btn btn-danger" onclick="openDeleteModal()">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Logout Button -->
        <div style="text-align: center; margin-top: 40px;">
            <button class="btn btn-primary" onclick="logout()" style="padding: 15px 40px; font-size: 16px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
    
    <!-- Password Change Modal -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal">
            <button class="modal-close" onclick="closePasswordModal()">&times;</button>
            <h2 class="modal-title"><i class="fas fa-key"></i> Change Password</h2>
            
            <div class="notification-box" id="passwordNotification"></div>
            
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" class="form-control" required minlength="8">
                    <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                        Must be at least 8 characters with letters and numbers
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-control" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="modal-btn secondary" onclick="closePasswordModal()">Cancel</button>
                    <button type="submit" class="modal-btn primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Verification Code Modal -->
    <div class="modal-overlay" id="verificationModal">
        <div class="modal">
            <button class="modal-close" onclick="closeVerificationModal()">&times;</button>
            <h2 class="modal-title"><i class="fas fa-envelope"></i> Verify Your Email</h2>
            
            <div class="modal-message">
                <p>We've sent a 6-digit verification code to your email address.</p>
                <p style="font-weight: 600; margin-top: 10px;" id="userEmailDisplay"></p>
                <p style="font-size: 14px; color: var(--gray); margin-top: 10px;">
                    Enter the code below to confirm your password change.
                </p>
            </div>
            
            <div class="code-inputs" id="codeInputs">
                <input type="text" class="code-input" maxlength="1" data-index="0">
                <input type="text" class="code-input" maxlength="1" data-index="1">
                <input type="text" class="code-input" maxlength="1" data-index="2">
                <input type="text" class="code-input" maxlength="1" data-index="3">
                <input type="text" class="code-input" maxlength="1" data-index="4">
                <input type="text" class="code-input" maxlength="1" data-index="5">
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p style="font-size: 14px; color: var(--gray);">
                    Didn't receive the code? 
                    <a href="#" onclick="resendVerificationCode()" style="color: var(--primary); text-decoration: none;">
                        Resend
                    </a>
                </p>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-btn secondary" onclick="closeVerificationModal()">Cancel</button>
                <button type="button" class="modal-btn primary" onclick="verifyCode()">Verify</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Account Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Delete Account</h2>
            
            <div class="modal-message">
                <p style="color: var(--danger); font-weight: 600;">
                    Warning: This action cannot be undone!
                </p>
                <p>All your data, including exam history, study progress, and personal information will be permanently deleted.</p>
                <p style="margin-top: 15px;">To confirm, please type "DELETE" below:</p>
            </div>
            
            <div class="form-group">
                <input type="text" id="deleteConfirmation" class="form-control" placeholder="Type DELETE to confirm">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-btn secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="modal-btn danger" onclick="confirmDeleteAccount()" id="deleteConfirmBtn" disabled>Delete Account</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCictHNxtslYs9VR0hoicxlwPn_QghkgIA",
            authDomain: "edutop-7ff51.firebaseapp.com",
            projectId: "edutop-7ff51",
            storageBucket: "edutop-7ff51.firebasestorage.app",
            messagingSenderId: "79307850494",
            appId: "1:79307850494:web:b51ce51204140ec5429baf",
            measurementId: "G-GGGH590BYS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let verificationCode = '';
        let newPasswordToSet = '';

        document.addEventListener('DOMContentLoaded', async function() {
            // Check auth
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = "index.html";
                    return;
                }
                
                currentUser = user;
                loadSettings();
                setupEventListeners();
            });
        });

        function loadSettings() {
            // Load dark mode preference
            const darkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeToggle').checked = darkMode;
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
            
            // Load other settings from localStorage or default
            const fontSize = localStorage.getItem('fontSize') || 'medium';
            document.getElementById('fontSizeSelect').value = fontSize;
            applyFontSize(fontSize);
            
            const emailNotifications = localStorage.getItem('emailNotifications') !== 'false';
            document.getElementById('emailNotifications').checked = emailNotifications;
            
            const examReminders = localStorage.getItem('examReminders') !== 'false';
            document.getElementById('examReminders').checked = examReminders;
            
            const studyGoals = localStorage.getItem('studyGoals') !== 'false';
            document.getElementById('studyGoals').checked = studyGoals;
            
            const twoFactor = localStorage.getItem('twoFactor') === 'true';
            document.getElementById('twoFactorToggle').checked = twoFactor;
            
            const profileVisibility = localStorage.getItem('profileVisibility') || 'public';
            document.getElementById('profileVisibility').value = profileVisibility;
            
            const dataSharing = localStorage.getItem('dataSharing') === 'true';
            document.getElementById('dataSharing').checked = dataSharing;
        }

        function setupEventListeners() {
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                const isDarkMode = this.checked;
                document.body.classList.toggle('dark-mode', isDarkMode);
                localStorage.setItem('darkMode', isDarkMode);
            });
            
            // Font size
            document.getElementById('fontSizeSelect').addEventListener('change', function() {
                const fontSize = this.value;
                localStorage.setItem('fontSize', fontSize);
                applyFontSize(fontSize);
            });
            
            // Notification toggles
            document.getElementById('emailNotifications').addEventListener('change', function() {
                localStorage.setItem('emailNotifications', this.checked);
            });
            
            document.getElementById('examReminders').addEventListener('change', function() {
                localStorage.setItem('examReminders', this.checked);
            });
            
            document.getElementById('studyGoals').addEventListener('change', function() {
                localStorage.setItem('studyGoals', this.checked);
            });
            
            // Two-factor authentication
            document.getElementById('twoFactorToggle').addEventListener('change', function() {
                localStorage.setItem('twoFactor', this.checked);
                if (this.checked) {
                    alert('Two-factor authentication has been enabled. You will receive a code via email for future logins.');
                }
            });
            
            // Privacy settings
            document.getElementById('profileVisibility').addEventListener('change', function() {
                localStorage.setItem('profileVisibility', this.value);
            });
            
            document.getElementById('dataSharing').addEventListener('change', function() {
                localStorage.setItem('dataSharing', this.checked);
            });
            
            // Password form
            document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await initiatePasswordChange();
            });
            
            // Delete confirmation input
            document.getElementById('deleteConfirmation').addEventListener('input', function() {
                document.getElementById('deleteConfirmBtn').disabled = 
                    this.value.toUpperCase() !== 'DELETE';
            });
            
            // Verification code inputs
            setupCodeInputs();
        }

        function applyFontSize(size) {
            const sizes = {
                'small': '14px',
                'medium': '16px',
                'large': '18px'
            };
            document.body.style.fontSize = sizes[size] || '16px';
        }

        function openPasswordModal() {
            closeAllModals();
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordNotification').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        async function initiatePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const notification = document.getElementById('passwordNotification');
            
            // Validate passwords
            if (newPassword !== confirmPassword) {
                notification.textContent = 'New passwords do not match.';
                notification.className = 'notification-box error';
                notification.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 8) {
                notification.textContent = 'Password must be at least 8 characters long.';
                notification.className = 'notification-box error';
                notification.style.display = 'block';
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                
                // Store new password and generate verification code
                newPasswordToSet = newPassword;
                verificationCode = generateVerificationCode();
                
                // Show verification modal
                closePasswordModal();
                openVerificationModal();
                
            } catch (error) {
                console.error('Error reauthenticating:', error);
                notification.textContent = 'Current password is incorrect.';
                notification.className = 'notification-box error';
                notification.style.display = 'block';
            }
        }

        function generateVerificationCode() {
            // Generate a 6-digit code
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function openVerificationModal() {
            document.getElementById('verificationModal').style.display = 'flex';
            document.getElementById('userEmailDisplay').textContent = currentUser.email;
            
            // In a real app, you would send this code via email
            // For demo purposes, we'll show it in an alert
            setTimeout(() => {
                alert(`DEMO: Your verification code is ${verificationCode}\n\nIn the real app, this would be sent to your email.`);
            }, 500);
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
            // Clear code inputs
            document.querySelectorAll('.code-input').forEach(input => {
                input.value = '';
            });
        }

        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-input');
            
            inputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
        }

        function verifyCode() {
            let enteredCode = '';
            document.querySelectorAll('.code-input').forEach(input => {
                enteredCode += input.value;
            });
            
            if (enteredCode === verificationCode) {
                // Code is correct, update password
                updatePasswordWithVerification();
            } else {
                alert('Invalid verification code. Please try again.');
            }
        }

        async function updatePasswordWithVerification() {
            try {
                await updatePassword(currentUser, newPasswordToSet);
                
                // Update user's password change history in Firestore
                await updateDoc(doc(db, "users", currentUser.uid), {
                    passwordChangedAt: new Date().toISOString(),
                    securityLogs: {
                        passwordChange: new Date().toISOString(),
                        ipAddress: 'tracked'
                    }
                });
                
                closeVerificationModal();
                
                // Show success message
                const successModal = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 400px;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 0 auto 20px;">
                                <i class="fas fa-check"></i>
                            </div>
                            <h3 style="color: var(--success); margin-bottom: 10px;">Password Changed!</h3>
                            <p>Your password has been successfully updated. Please use your new password for future logins.</p>
                            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer;">
                                OK
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', successModal);
                
            } catch (error) {
                console.error('Error updating password:', error);
                alert('Failed to update password: ' + error.message);
                closeVerificationModal();
            }
        }

        function resendVerificationCode() {
            verificationCode = generateVerificationCode();
            
            // In a real app, resend email
            alert(`DEMO: New verification code: ${verificationCode}\n\nCode has been resent to your email.`);
        }

        function viewLoginActivity() {
            alert('This would show your recent login sessions with IP addresses and timestamps. For security reasons, this feature requires backend implementation.');
        }

        function exportData() {
            alert('Your data export has been initiated. You will receive an email with a download link within 24 hours.');
            
            // In a real app, this would trigger a data export process
            // For now, we'll simulate by creating a JSON file
            const userData = {
                userId: currentUser.uid,
                email: currentUser.email,
                exportDate: new Date().toISOString(),
                message: 'Data export requested. In the real app, this would contain all your data.'
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `edutop-data-export-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openDeleteModal() {
            closeAllModals();
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('deleteConfirmation').value = '';
            document.getElementById('deleteConfirmBtn').disabled = true;
        }

        async function confirmDeleteAccount() {
            try {
                // Delete user data from Firestore
                await deleteDoc(doc(db, "users", currentUser.uid));
                
                // Delete user from Firebase Auth
                // Note: In a real app, you would need Cloud Functions to delete auth user
                // For demo, we'll just sign out
                await signOut(auth);
                
                alert('Account deletion requested. All your data has been deleted from our systems. You will be logged out.');
                
                window.location.href = "index.html";
                
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Failed to delete account: ' + error.message);
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        async function logout() {
            try {
                await signOut(auth);
                window.location.href = "index.html";
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Failed to logout: ' + error.message);
            }
        }

    </script>
</body>
</html>
